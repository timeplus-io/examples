# Logstash Configuration for Cisco ASA Logs
# Complete event-specific parsing with correct grok patterns

filter {
  # ============================================================
  # STEP 1: Parse the ASA syslog header
  # ============================================================
  grok {
    match => {
      "message" => "<%{POSINT:priority}>%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:device} %%{WORD:facility}-%{INT:severity}-%{INT:event_id}: %{GREEDYDATA:asa_message}"
    }
  }

  # ============================================================
  # STEP 2: Branch based on event_id and parse message details
  # ============================================================
  
  # ------------------------------------------------------------
  # 302013: Built TCP Connection (HAS NAT IPs in parentheses)
  # Format: Built {inbound|outbound} TCP connection ID for src:ip/port (nat_ip/port) to dst:ip/port (nat_ip/port)
  # ------------------------------------------------------------
  if [event_id] == "302013" {
    grok {
      match => {
        "asa_message" => "Built %{DATA:direction} %{DATA:protocol} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} \(%{IP:nat_src_ip}\/%{INT:nat_src_port}\) to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} \(%{IP:nat_dst_ip}\/%{INT:nat_dst_port}\)"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
        "connection_id" => "integer"
        "nat_src_port" => "integer"
        "nat_dst_port" => "integer"
      }
    }
  }
  
  # ------------------------------------------------------------
  # 302014: Teardown TCP Connection (NO NAT IPs, has duration/bytes/reason)
  # Format: Teardown TCP connection ID for src:ip/port to dst:ip/port duration H:MM:SS bytes ### reason
  # ------------------------------------------------------------
  else if [event_id] == "302014" {
    grok {
      match => {
        "asa_message" => "Teardown %{DATA:protocol} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} duration %{DATA:duration} bytes %{INT:bytes} %{GREEDYDATA:reason}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
        "connection_id" => "integer"
        "bytes" => "integer"
      }
    }
  }
  
  # ------------------------------------------------------------
  # 302015: Built UDP Connection (similar to 302013 with NAT IPs)
  # Format: Built {inbound|outbound} UDP connection ID for src:ip/port (nat_ip/port) to dst:ip/port (nat_ip/port)
  # ------------------------------------------------------------
  else if [event_id] == "302015" {
    grok {
      match => {
        "asa_message" => "Built %{DATA:direction} %{DATA:protocol} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} \(%{IP:nat_src_ip}\/%{INT:nat_src_port}\) to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} \(%{IP:nat_dst_ip}\/%{INT:nat_dst_port}\)"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
        "connection_id" => "integer"
        "nat_src_port" => "integer"
        "nat_dst_port" => "integer"
      }
    }
  }
  
  # ------------------------------------------------------------
  # 302016: Teardown UDP Connection (NO NAT IPs, has duration/bytes)
  # Format: Teardown UDP connection ID for src:ip/port to dst:ip/port duration H:MM:SS bytes ###
  # ------------------------------------------------------------
  else if [event_id] == "302016" {
    grok {
      match => {
        "asa_message" => "Teardown %{DATA:protocol} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} duration %{DATA:duration} bytes %{INT:bytes}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
        "connection_id" => "integer"
        "bytes" => "integer"
      }
    }
  }
  
  # ------------------------------------------------------------
  # 302020: Built ICMP Connection
  # Format: Built {inbound|outbound} ICMP connection for faddr ip/0 gaddr ip/0 laddr ip/0
  # ------------------------------------------------------------
  else if [event_id] == "302020" {
    grok {
      match => {
        "asa_message" => "Built %{DATA:direction} ICMP connection for faddr %{IP:faddr}\/0 gaddr %{IP:gaddr}\/0 laddr %{IP:laddr}\/0"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ------------------------------------------------------------
  # 302021: Teardown ICMP Connection
  # Format: Teardown ICMP connection for faddr ip/0 gaddr ip/0 laddr ip/0 duration H:MM:SS bytes ###
  # ------------------------------------------------------------
  else if [event_id] == "302021" {
    grok {
      match => {
        "asa_message" => "Teardown ICMP connection for faddr %{IP:faddr}\/0 gaddr %{IP:gaddr}\/0 laddr %{IP:laddr}\/0 duration %{DATA:duration} bytes %{INT:bytes}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { "bytes" => "integer" }
    }
  }
  
  # ------------------------------------------------------------
  # 305011: Built Dynamic Translation
  # Format: Built dynamic {TCP|UDP|ICMP} translation from src:ip/port to dst:ip/port
  # NOTE: Uses "from...to" not "for...to"
  # ------------------------------------------------------------
  else if [event_id] == "305011" {
    grok {
      match => {
        "asa_message" => "Built dynamic %{DATA:protocol} translation from %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
      }
    }
  }
  
  # ------------------------------------------------------------
  # 305012: Teardown Dynamic Translation
  # Format: Teardown dynamic {TCP|UDP|ICMP} translation from src:ip/port to dst:ip/port duration H:MM:SS
  # NOTE: Uses "from...to" not "for...to"
  # ------------------------------------------------------------
  else if [event_id] == "305012" {
    grok {
      match => {
        "asa_message" => "Teardown dynamic %{DATA:protocol} translation from %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} to %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} duration %{DATA:duration}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
      }
    }
  }
  
  # ------------------------------------------------------------
  # 106023: Deny tcp/udp by ACL
  # Format: Deny {tcp|udp} src src_ifc:src_ip/src_port dst dst_ifc:dst_ip/dst_port by access-group "ACL_NAME" [0x0, 0x0]
  # ------------------------------------------------------------
  else if [event_id] == "106023" {
    grok {
      match => {
        "asa_message" => "Deny %{DATA:protocol} src %{DATA:src_interface}:%{IP:src_ip}\/%{INT:src_port} dst %{DATA:dst_interface}:%{IP:dst_ip}\/%{INT:dst_port} by access-group \"%{DATA:acl_name}\" \[%{DATA:hex_codes}\]"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
      }
    }
  }
  
  # ------------------------------------------------------------
  # 106015: Deny TCP (no connection)
  # Format: Deny {TCP|UDP} (no connection) from src_ip/src_port to dst_ip/dst_port flags {flags} on interface ifc_name
  # ------------------------------------------------------------
  else if [event_id] == "106015" {
    grok {
      match => {
        "asa_message" => "Deny %{DATA:protocol} \(no connection\) from %{IP:src_ip}\/%{INT:src_port} to %{IP:dst_ip}\/%{INT:dst_port} flags %{DATA:tcp_flags} on interface %{DATA:interface}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "src_port" => "integer" 
        "dst_port" => "integer" 
      }
    }
  }
  
  # ------------------------------------------------------------
  # 106001: Deny reverse path check
  # Format: Deny {tcp|udp|icmp} reverse path check from src_ip to dst_ip on interface ifc_name
  # ------------------------------------------------------------
  else if [event_id] == "106001" {
    grok {
      match => {
        "asa_message" => "Deny %{DATA:protocol} reverse path check from %{IP:src_ip} to %{IP:dst_ip} on interface %{DATA:interface}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ------------------------------------------------------------
  # 313001: Denied ICMP
  # Format: Denied ICMP type=##, code=## from src_ip on interface ifc_name due to rate limit
  # ------------------------------------------------------------
  else if [event_id] == "313001" {
    grok {
      match => {
        "asa_message" => "Denied ICMP type=%{INT:icmp_type}, code=%{INT:icmp_code} from %{IP:src_ip} on interface %{DATA:interface}%{GREEDYDATA:reason}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { 
        "icmp_type" => "integer" 
        "icmp_code" => "integer" 
      }
    }
  }
  
  # ------------------------------------------------------------
  # 313004: Denied ICMP (no matching session)
  # Format: Denied ICMP type=##, from laddr src_ip on interface ifc_name to dst_ip: no matching session
  # ------------------------------------------------------------
  else if [event_id] == "313004" {
    grok {
      match => {
        "asa_message" => "Denied ICMP type=%{INT:icmp_type}, from laddr %{IP:src_ip} on interface %{DATA:interface} to %{IP:dst_ip}: %{GREEDYDATA:reason}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { "icmp_type" => "integer" }
    }
  }
  
  # ------------------------------------------------------------
  # 313005: No matching connection for ICMP error
  # Format: No matching connection for ICMP error message: {details} on {interface} interface. Original IP payload: {details}
  # ------------------------------------------------------------
  else if [event_id] == "313005" {
    grok {
      match => {
        "asa_message" => "No matching connection for ICMP error message: %{GREEDYDATA:icmp_details}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ------------------------------------------------------------
  # 400013: IDS Alert
  # Format: IDS:#### ICMP echo request from src_ip to dst_ip on interface ifc_name
  # ------------------------------------------------------------
  else if [event_id] == "400013" {
    grok {
      match => {
        "asa_message" => "IDS:%{INT:ids_signature} ICMP echo request from %{IP:src_ip} to %{IP:dst_ip} on interface %{DATA:interface}"
      }
      remove_field => ["asa_message"]
    }
    mutate {
      convert => { "ids_signature" => "integer" }
    }
  }
  
  # ------------------------------------------------------------
  # 113004: AAA Authentication Successful
  # Format: AAA user authentication Successful: server = server_ip, user = username
  # ------------------------------------------------------------
  else if [event_id] == "113004" {
    grok {
      match => {
        "asa_message" => "AAA user authentication Successful: server = %{IP:aaa_server}, user = %{DATA:username}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ------------------------------------------------------------
  # 113015: AAA Authentication Rejected
  # Format: AAA user authentication Rejected: reason = {reason}: user = username, server = server_ip
  # ------------------------------------------------------------
  else if [event_id] == "113015" {
    grok {
      match => {
        "asa_message" => "AAA user authentication Rejected: reason = %{DATA:auth_reason}: user = %{DATA:username}, server = %{IP:aaa_server}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ------------------------------------------------------------
  # 713172: VPN IP Assignment
  # Format: Group = vpn_group, IP = src_ip, Assigned private IP = private_ip
  # ------------------------------------------------------------
  else if [event_id] == "713172" {
    grok {
      match => {
        "asa_message" => "Group = %{DATA:vpn_group}, IP = %{IP:public_ip}, Assigned private IP = %{IP:private_ip}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ============================================================
  # STEP 3: Convert common fields to proper types
  # ============================================================
  mutate {
    convert => { 
      "priority" => "integer"
      "severity" => "integer"
      "event_id" => "integer"
    }
  }
  
  # ============================================================
  # STEP 4: Add timestamp parsing (optional)
  # ============================================================
  date {
    match => [ "timestamp", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss" ]
    target => "@timestamp"
  }
}