input {
  kafka {
    bootstrap_servers => "redpanda:9092"
    topics => ["cisco_asa_logs"]
    codec => json
    consumer_threads => 1
    group_id => "logstash-cisco-asa-parser"
    auto_offset_reset => "earliest"
  }
}

filter {
  # ============================================================
  # STEP 1: Parse the ASA syslog header
  # ============================================================
  grok {
    match => {
      "message" => "<%{POSINT:priority}>%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:device} %%{WORD:facility}-%{INT:severity}-%{INT:event_id}: %{GREEDYDATA:asa_message}"
    }
  }

  # ============================================================
  # STEP 2: Use custom patterns directory
  # Reference: /etc/logstash/patterns/cisco-asa-custom
  # ============================================================
  
  # Connection tracking events (302013, 302014, 302015, 302016)
  if [event_id] in ["302013", "302014", "302015", "302016"] {
    grok {
      match => {
        "asa_message" => "%{CISCOFW302013_302014_302015_302016}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ICMP connections (302020, 302021)
  else if [event_id] in ["302020", "302021"] {
    grok {
      match => {
        "asa_message" => "%{CISCOFW302020_302021}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # Dynamic translation (305011)
  else if [event_id] == "305011" {
    grok {
      match => {
        "asa_message" => "%{CISCOFW305011}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # Access control - connection denied (106001)
  else if [event_id] == "106001" {
    grok {
      match => {
        "asa_message" => "%{CISCOFW106001}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # Access control - ACL deny (106023)
  else if [event_id] == "106023" {
    grok {
      match => {
        "asa_message" => "%{CISCOFW106023}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # TCP no connection (106015)
  else if [event_id] == "106015" {
    grok {
      match => {
        "asa_message" => "%{CISCOFW106015}"
      }
      remove_field => ["asa_message"]
    }
  }
  
  # ============================================================
  # STEP 3: Convert common fields to proper types
  # ============================================================
  mutate {
    convert => { 
      "priority" => "integer"
      "severity" => "integer"
      "event_id" => "integer"
    }
  }
  
  # ============================================================
  # STEP 4: Add timestamp parsing
  # ============================================================
  date {
    match => [ "timestamp", "MMM dd HH:mm:ss", "MMM  d HH:mm:ss" ]
    target => "@timestamp"
  }
  
  # Add a field to mark successful parsing
  mutate {
    add_field => { "parsed" => "true" }
  }
}

output {
  kafka {
    bootstrap_servers => "redpanda:9092"
    topic_id => "cisco_asa_parsed_logstash"
    codec => json
  }
  
  # Optional: Debug output
  # stdout { codec => rubydebug }
}